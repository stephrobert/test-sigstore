name: SLSA Verification

on:
  schedule:
    # Vérifier toutes les nuits
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Install slsa-verifier
        run: |
          curl -LO https://github.com/slsa-framework/slsa-verifier/releases/latest/download/slsa-verifier-linux-amd64
          chmod +x slsa-verifier-linux-amd64
          sudo mv slsa-verifier-linux-amd64 /usr/local/bin/slsa-verifier

      - name: Get latest tag
        id: latest
        run: |
          LATEST_TAG=$(gh api repos/${{ github.repository }}/tags --jq '.[0].name')
          echo "tag=$LATEST_TAG" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get image digest
        id: digest
        run: |
          DIGEST=$(docker pull ghcr.io/${{ github.repository }}:${{ steps.latest.outputs.tag }} 2>&1 | grep "Digest:" | cut -d' ' -f2)
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT

      - name: Verify SLSA with GitHub Attestations
        run: |
          gh attestation verify oci://ghcr.io/${{ github.repository }}@${{ steps.digest.outputs.digest }} \
            --owner ${{ github.repository_owner }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Report status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ SLSA verification passed for ${{ steps.latest.outputs.tag }}"
          else
            echo "❌ SLSA verification failed for ${{ steps.latest.outputs.tag }}"
            exit 1
          fi
